# 第一部分：数据结构与对象

## 字符串 (Simple Dynamic String)

Redis 没有使用 C 语言中的 `\0` 结尾的方式表示一个字符串，而是自己构建了一个结构 SDS  作为基本字符串类型。这一结构的定义和实现分别在源码的 `src/sds.h`、`src/sds.c` 这两个文件中。

### 结构

以最长 256 字节长度串的结构 `sdshdr8` 为例：

```c
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len; /* used */
    uint8_t alloc; /* excluding the header and null terminator */
    unsigned char flags; /* 3 lsb of type, 5 unused bits */
    char buf[];
};
```

由上面的源码可以看出 SDS 结构的核心是：

1. `len`：已经使用的字符串长度；

2. `alloc`：总共分配的缓冲区长度；

   SDS 为了兼容 C 语言的空字符串结尾，会额外分配一个字节的大小，如果假设字符串可以增加的大小为 `rmd`，那么有公式：`alloc = rmd + len + 1`；

3. `buf`：字符串字面量；

像大多数高级语言一样，使用简单动态字符串这种封装方式有以下好处：

1. 获取字符串长度，时间复杂度 `O(1)`；
2. 二进制安全：杜绝缓冲区溢出、可以存储二进制形式的字符串；
3. 减少修改字符串所需要的内存重新分配次数；
4. 兼容部分 C 字符串函数；

### 方法

`sds` 的创建核心方法可以看到源码中的 `_sdsnewlen`，它的函数签名如下：

```c
sds _sdsnewlen(const void *init, size_t initlen, int trymalloc)
```

在这个函数中可以看到 `sds` 的内存排列方式：

```c
    s = (char*)sh+hdrlen;
    fp = ((unsigned char*)s)-1;
    usable = usable-hdrlen-1;
```

其中 `s` 就是 sds 结构中的 `buf`，并最终赋值给了 `sds` 结构指针；

## 链表 (A Generic Doubly Linked List)

Redis 链表的底层是一个无环双向链表，结构可以在 `src/adlink.h`、`src/adlink.c` 这两个文件中看到。

链表的节点使用结构 `listNode`：

```c
typedef struct listNode {
    struct listNode *prev;
    struct listNode *next;
    void *value;
} listNode;
```

链表本身使用结构 `list`：

```c
typedef struct list {
    listNode *head;
    listNode *tail;
    void *(*dup)(void *ptr);
    void (*free)(void *ptr);
    int (*match)(void *ptr, void *key);
    unsigned long len;
} list;
```

除了 头节点 `head`、尾节点 `tail`、以及链表长度 `len`，结构中另外三个是三个函数：

- `dup` 函数用于复制节点，`free` 函数用于释放节点、`match` 函数用于比较节点；

- 因为 `listNode` 的 `value` 可以指向任意对象，因此需要为 `list` 结构的实例设置三个用于操作节点的函数，这其实是一种多态的体现；

## 字典 (Hash Table)

字典的结构与核心方法可以在 `src/dict.c` 与 `src/dict.h` 这两个文件中看到。

### 结构

实现字典的结构中过程中，涉及了三个核心结构。

字典本身使用 `dict` 这个结构实现的：

```c
typedef struct dict {
    dictType *type;
    void *privdata;
    dictht ht[2];
    long rehashidx; /* rehashing not in progress if rehashidx == -1 */
    int16_t pauserehash; /* If >0 rehashing is paused (<0 indicates coding error) */
} dict;
```

1. 跟 `list` 类似，其中 `dictType` 是一个为了实现多态的函数指针封装；
2. `dictht` 结构才是实现字典的核心结构；
3. `dict` 持有两个 `dictht` 并且定义了 `rehashidx`/`rehashidx` 这些成员变量，是为了 `rehash` 的性能与可用性的考虑；

哈希表使用 `dictht` 实现：

```c
typedef struct dictht {
    dictEntry **table;
    unsigned long size;
    unsigned long sizemask;
    unsigned long used;
} dictht;
```

其中 `dictEntry` 是以链式存储的哈希表节点：

```c
typedef struct dictEntry {
    void *key;
    union {
        void *val;
        uint64_t u64;
        int64_t s64;
        double d;
    } v;
    struct dictEntry *next;
} dictEntry;
```

