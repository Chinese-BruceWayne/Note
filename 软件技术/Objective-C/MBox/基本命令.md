# 基本命令

## 仓库操作

### init

命令基本使用：

```bash
$ mbox init <PLATFORM_NAME>
```

其中：

- `PLATFORM_NAME` 指平台名，目前只支持三个参数 `ios`、`ruby` 与 `stable`。

注意事项：

1. 初始化工作空间所做的工作只是在当前目录下创建了一个 `.mbox/` 目录。

2. 需要注意的是：初始化工作空间时，请进入一个空目录。
3. *Author*：初始化不会创建新的目录而是直接使用当前目录。这点与 `git` 也是类似的。

### add

命令基本使用：

```bash
$ mbox add <URL_PATH> <BASE_BRANCH>
```

其中：

- `URL_PATH` 指项目地址，支持：git 地址、本地目录路径、POD 名；
- `BASE_BRANCH` 用来标记增加 Pod 后 MBox 第一次切换的分支：
  - 若是 git 地址，则是远程仓库的默认分支；
  - 若是本地地址，则是本地项目的当前分支；
  - 若是 Pod 名，则是 Podfile 对应的分支；

注意事项：

1. 使用 NAME 和 URL 添加项目时，如果项目已经下载过，则直接引入当前 Workspace，否则进入下载流程；使用 PATH 添加项目，后续会提问用户，是应该采用 **复制** 还是 **移动**。
2. 如果当前 mbox 处于某个 Feature，则该项目将会加入该 Feature，并自动切换对应的 Feature 分支。

### remove

命令基本使用：

```bash
$ mbox remove <NAME> [--include-repo] [--force]
```

其中：

- `NAME` 指项目的名称；
- 指定 `--include-repo` 参数时，会将项目同仓库一起移除；
- 指定 `--force` 参数时，如果存在未 commit 的改动，也会被强制删除；

###  git

命令的作用是通过 mbox 执行 git 的原生指令。命令基本使用：

 ```bash
$ mbox git <git command>
 ```

目的：

- 有时候期望能够同时对每个项目执行相同的命令，最常用的命令就是 git 命令。
- 这个指令会遍历所有项目，将会以同步方式顺序对每个项目执行相同的命令。

### repo

命令基本使用：

```bash
$ mbox repo <command>
```

其中 `command` 参数提供了以下的几个选项：

- `clean`：从缓存区域中彻底的将当前未使用的仓库删除；

  与 `remove` 不同的是，后者只会删除仓库的符号链接，而前者则会彻底删除，比如：

  ```bash
  $ mbox remove <REPO_NAME>
  
  $ mbox repo clean
  ```

  这两行命令会将 `REPO_NAME` 这个仓库彻底删除；

- `sync`：根据主仓来同步子仓分支状况，根据 `Podfile.lock` 自动对齐；

  - 这条会自动执行 `mbox pod install`，如果不想执行则需要指定 `--no-install` 命令；

更多详细的用法可以直接查看命令帮助：

```bash
$ mbox repo --help
```

## Feature 命令

什么是 Feature？

- 概念源自于 git flow，旨在令开发人员在做日常业务时，关注点放在需求和业务上；
- 我们可以将它简单地理解为分支的统一，使用一个 Feature 对多个 Repo 的制定分支进行关联；

###start 

命令基本使用：

```bash
$ mbox feature start <NAME>
```

使用这个命令会：

1. 如果 Feature 是新的，则会复制当前项目的列表（如果指定 `--clear` 参数，则会创建空项目列表）
2. 切换到一个新的 Feature（如果缓存中不存在同名且存在的 Name）
3. 或者切换到一个旧的 Feature切的流程主要会执行下面的几个步骤：
4. 将当前文件夹下的项目列表，还原为目标 Feature 中的项目列表；
5. `stash` 项目原来的修改（可以指定 `--no-stash` 选项跳过该步骤）
6. 如果目标 Feature 是新的，则执行：
   - 每个项目切换到 Base Branch 分支（默认 develop）；更新 Base Branch；
7. 切换项目分支到目标 Feature 所在的分支（如果没有这样的分支，则会新建一个）；
8. 每个项目都会 `git apply` 之前 `stash` 的内容；
9. 检测 lock 文件差异，并且执行 `mbox pod install`（如果指定了 `--no-install` 参数，则不会执行这一步）

### finish

命令基本使用：

```bash
$ mbox feature finish
```

这个命令的主要作用是结束当前 Feature，切回 Free 模式，更新 base 分支的代码。

在执行命令之前会查询当前 Feature 相关的 MR 的状态（Opened, Merged, Closed），检测是否全部状态通过且 MR 已经变为 Merge 状态。

在 `CocoaPods` 的模式下，我们可以将所有的仓库分为主仓和 Pod 仓两个概念：

1. 主仓：`Podfile` 所在的仓库，所有的仓库版本依赖都在这里面声明；
2. Pod 仓：我们的一些组件；

根据这两种仓库的存在与否，会出现三种情况：

1. 仅有主仓：这时就与单一仓库开发流程是一致的；
2. 仅有 Pod 仓：此时提交并 Merge 的之后，需要更新主仓的  `Podfile` 与 `Podfile.lock` 文件。
3. 既有主仓，又有 Pod 仓：此时当 Pod 仓库所有的 MR 进入 Merge 状态后，会对主仓做出与 case 2 中相同的策略并将这个 commit push 到 Feature 分支当前的 MR 上，一通进入 MR Review 流程。再次执行 `feature finish` 检测主仓状态，完成 Feature 流程。

### 其他常用命令

1. 切换到 free 模式：

   ```bash
   $ mbox feature free
   ```

2. 列举出所有的 feature：

   ```bash
   $ mbox feature list
   ```

3. 清理所有已经被合并的 Feature：

   ```bash
   $ mbox feature clean
   ```

4. 对当前 Feature 上的所有改动创建 MR。目标分支为 Base 分支：

   ```bash
   $ mbox feature merge
   ```

5. 查询当前 Feature 对应的 MR 状态：

   ```bash
   $ mbox feature check
   ```

6. 删除指定 Feature，不允许当前处于指定的 Feature 之上：

    ```bash
   $ mbox feature remove <FEATURE_NAME>
    ```

   